name: BMS Advance Tracker (2,3,4,5)

on:
  workflow_dispatch:
  schedule:
    # IST window mapped in UTC (every 2 hours window)
    - cron: "0 21-23,0-17 * * *"
    
permissions:
  contents: write

jobs:
# =====================================================
# 1ï¸âƒ£ Decide DATE OFFSET + FREEZE DATE_CODE
# =====================================================
  decide-day:
    runs-on: ubuntu-latest
    outputs:
      days_ahead: ${{ steps.set.outputs.days_ahead }}
      date_code:  ${{ steps.set.outputs.date_code }}

    steps:
      - name: Decide tracking day (FREEZE)
        id: set
        run: |
          RUN_INDEX=$(( $(date -u +%H) ))

          ARR=(2 3 4 2 5 3 4)
          LEN=${#ARR[@]}
          IDX=$(( RUN_INDEX % LEN ))
          DAYS_AHEAD=${ARR[$IDX]}

          if [ -z "$DAYS_AHEAD" ]; then
            echo "âŒ DAYS_AHEAD empty"
            exit 1
          fi

          DATE_CODE=$(TZ=Asia/Kolkata date -d "+${DAYS_AHEAD} day" +%Y%m%d)

          echo "Run index  : $RUN_INDEX"
          echo "Day offset : +$DAYS_AHEAD"
          echo "DATE_CODE  : $DATE_CODE"

          echo "days_ahead=$DAYS_AHEAD" >> $GITHUB_OUTPUT
          echo "date_code=$DATE_CODE"   >> $GITHUB_OUTPUT

# =====================================================
# 2ï¸âƒ£ Run ALL shards in parallel (1â€“9)
# =====================================================
  shards:
    name: Shard ${{ matrix.shard }}
    needs: decide-day
    runs-on: ubuntu-latest
    timeout-minutes: 60

    strategy:
      fail-fast: false
      matrix:
        shard: [1,2,3,4,5,6,7,8,9]

    steps:
      - name: ğŸ§¾ Checkout repo
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          persist-credentials: true

      - name: ğŸ Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: ğŸ“¦ Install Python dependencies
        run: |
          python -m pip install --upgrade pip
          pip install cloudscraper aiohttp pytz selenium webdriver-manager

      - name: ğŸš€ Run shard scraper
        run: |
          python bmsrotate${{ matrix.shard }}.py
        env:
          DAYS_AHEAD: ${{ needs.decide-day.outputs.days_ahead }}
          DATE_CODE:  ${{ needs.decide-day.outputs.date_code }}

      - name: ğŸ’¾ Commit shard output (REBASE SAFE)
        run: |
          git config user.name "github-actions"
          git config user.email "actions@github.com"

          git add advance/data/${{ needs.decide-day.outputs.date_code }}/
          git commit -m "Shard ${{ matrix.shard }} data (${{
            needs.decide-day.outputs.date_code
          }})" || echo "Nothing to commit"

          # ğŸ” rebase-safe retry push
          for i in 1 2 3; do
            git pull --rebase origin main || true
            git push origin main && break
            echo "Retry push $i..."
            sleep 3
          done

# =====================================================
# 3ï¸âƒ£ Combine shards (AFTER ALL SHARDS FINISH)
# =====================================================
  combine:
    name: Combine all shards
    needs: [decide-day, shards]
    runs-on: ubuntu-latest
    timeout-minutes: 30

    steps:
      - name: ğŸ§¾ Checkout repo
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          persist-credentials: true

      - name: ğŸ Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: ğŸ“¦ Install combiner deps
        run: |
          pip install pytz

      - name: ğŸ”— Combine shard JSONs
        run: |
          python combine_shards_rotate.py
        env:
          DATE_CODE: ${{ needs.decide-day.outputs.date_code }}

      - name: ğŸ’¾ Commit final combined JSONs (REBASE SAFE)
        run: |
          git config user.name "github-actions"
          git config user.email "actions@github.com"

          git add advance/data/${{ needs.decide-day.outputs.date_code }}/finaldetailed.json
          git add advance/data/${{ needs.decide-day.outputs.date_code }}/finalsummary.json

          git commit -m "Final combined BMS data (${{
            needs.decide-day.outputs.date_code
          }})" || echo "Nothing to commit"

          # ğŸ” rebase-safe retry push (NO FORCE)
          for i in 1 2 3; do
            git pull --rebase origin main || true
            git push origin main && break
            echo "Retry push $i..."
            sleep 3
          done
