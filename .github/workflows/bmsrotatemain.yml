name: BMS Advance Tracker (Matrix + Parallel)

on:
  workflow_dispatch:
  schedule:
    - cron: "0 */2 * * *"   # every 2 hours

jobs:
  # =====================================================
  # 1️⃣ Decide DATE OFFSET (rotation)
  # =====================================================
  decide-day:
    runs-on: ubuntu-latest
    outputs:
      days_ahead: ${{ steps.set.outputs.days_ahead }}

    steps:
      - name: Decide tracking day
        id: set
        run: |
          RUN_INDEX=$(( ($(date -u +%H) / 2) ))

          # exact rotation required
          ARR=(2 3 4 2 5 3 4)
          LEN=${#ARR[@]}
          IDX=$(( RUN_INDEX % LEN ))
          DAYS_AHEAD=${ARR[$IDX]}

          echo "Run index  : $RUN_INDEX"
          echo "Day offset : +$DAYS_AHEAD"

          echo "days_ahead=$DAYS_AHEAD" >> $GITHUB_OUTPUT

  # =====================================================
  # 2️⃣ Run ALL scrapers in parallel (1–9)
  # =====================================================
  scrape:
    needs: decide-day
    runs-on: ubuntu-latest

    strategy:
      fail-fast: false
      matrix:
        shard: [1, 2, 3, 4, 5, 6, 7, 8, 9]

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install deps (only once per runner)
        run: |
          pip install cloudscraper aiohttp pytz

      - name: Run scraper
        run: python bmsrotate${{ matrix.shard }}.py
        env:
          DAYS_AHEAD: ${{ needs.decide-day.outputs.days_ahead }}

  # =====================================================
  # 3️⃣ Combine shards (after ALL finish)
  # =====================================================
  combine:
    needs: scrape
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Combine shards
        run: python combine_shards_rotate.py
        env:
          DAYS_AHEAD: ${{ needs.decide-day.outputs.days_ahead }}
